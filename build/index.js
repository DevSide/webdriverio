"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.multiremote = exports.attach = exports.remote = void 0;

require("source-map-support/register");

var _path = _interopRequireDefault(require("path"));

var _webdriver = _interopRequireDefault(require("webdriver"));

var _config = require("@wdio/config");

var _multiremote = _interopRequireDefault(require("./multiremote"));

var _constants = require("./constants");

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * A method to create a new session with WebdriverIO
 *
 * @param  {Object} [params={}]       Options to create the session with
 * @param  {function} remoteModifier  Modifier function to change the monad object
 * @return {object}                   browser object with sessionId
 */
const remote = async function (params = {}, remoteModifier) {
  const config = (0, _config.validateConfig)(_constants.WDIO_DEFAULTS, params);

  const modifier = (client, options) => {
    if (typeof remoteModifier === 'function') {
      client = remoteModifier(client, Object.assign(options, config));
    }

    Object.assign(options, config);
    return client;
  };

  if (params.user && params.key) {
    params = Object.assign({}, (0, _config.detectBackend)(params), params);
  }

  if (params.outputDir) {
    process.env.WDIO_LOG_PATH = _path.default.join(params.outputDir, 'wdio.log');
  }

  const prototype = (0, _utils.getPrototype)('browser');
  const instance = await _webdriver.default.newSession(params, modifier, prototype, _config.wrapCommand);
  /**
   * we need to overwrite the original addCommand and overwriteCommand
   * in order to wrap the function within Fibers
   */

  const origAddCommand = instance.addCommand.bind(instance);

  instance.addCommand = (name, fn, attachToElement) => origAddCommand(name, (0, _config.runFnInFiberContext)(fn), attachToElement);

  const origOverwriteCommand = instance.overwriteCommand.bind(instance);

  instance.overwriteCommand = (name, fn, attachToElement) => origOverwriteCommand(name, (0, _config.runFnInFiberContext)(fn), attachToElement);

  return instance;
};

exports.remote = remote;

const attach = function (params) {
  const prototype = (0, _utils.getPrototype)('browser');
  return _webdriver.default.attachToSession(params, null, prototype, _config.wrapCommand);
};

exports.attach = attach;

const multiremote = async function (params = {}) {
  const multibrowser = new _multiremote.default();
  const browserNames = Object.keys(params);
  /**
   * create all instance sessions
   */

  await Promise.all(browserNames.map(browserName => {
    const config = (0, _config.validateConfig)(_constants.WDIO_DEFAULTS, params[browserName]);

    const modifier = (client, options) => {
      Object.assign(options, config);
      return client;
    };

    const prototype = (0, _utils.getPrototype)('browser');

    const instance = _webdriver.default.newSession(params[browserName], modifier, prototype, _config.wrapCommand);

    return multibrowser.addInstance(browserName, instance);
  }));
  /**
   * use attachToSession capability to wrap instances around blank pod
   */

  const prototype = (0, _utils.getPrototype)('browser');
  const sessionParams = {
    sessionId: '',
    isW3C: multibrowser.instances[browserNames[0]].isW3C,
    logLevel: multibrowser.instances[browserNames[0]].options.logLevel
  };

  const driver = _webdriver.default.attachToSession(sessionParams, multibrowser.modifier.bind(multibrowser), prototype, _config.wrapCommand);
  /**
   * in order to get custom command overwritten or added to multiremote instance
   * we need to pass in the prototype of the multibrowser
   */


  const origAddCommand = driver.addCommand.bind(driver);

  driver.addCommand = (name, fn, attachToElement) => {
    origAddCommand(name, (0, _config.runFnInFiberContext)(fn), attachToElement, Object.getPrototypeOf(multibrowser.baseInstance), multibrowser.instances);
  };

  const origOverwriteCommand = driver.overwriteCommand.bind(driver);

  driver.overwriteCommand = (name, fn, attachToElement) => {
    origOverwriteCommand(name, (0, _config.runFnInFiberContext)(fn), attachToElement, Object.getPrototypeOf(multibrowser.baseInstance), multibrowser.instances);
  };

  return driver;
};

exports.multiremote = multiremote;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJyZW1vdGUiLCJwYXJhbXMiLCJyZW1vdGVNb2RpZmllciIsImNvbmZpZyIsIldESU9fREVGQVVMVFMiLCJtb2RpZmllciIsImNsaWVudCIsIm9wdGlvbnMiLCJPYmplY3QiLCJhc3NpZ24iLCJ1c2VyIiwia2V5Iiwib3V0cHV0RGlyIiwicHJvY2VzcyIsImVudiIsIldESU9fTE9HX1BBVEgiLCJwYXRoIiwiam9pbiIsInByb3RvdHlwZSIsImluc3RhbmNlIiwiV2ViRHJpdmVyIiwibmV3U2Vzc2lvbiIsIndyYXBDb21tYW5kIiwib3JpZ0FkZENvbW1hbmQiLCJhZGRDb21tYW5kIiwibmFtZSIsImZuIiwiYXR0YWNoVG9FbGVtZW50Iiwib3JpZ092ZXJ3cml0ZUNvbW1hbmQiLCJvdmVyd3JpdGVDb21tYW5kIiwiYXR0YWNoIiwiYXR0YWNoVG9TZXNzaW9uIiwibXVsdGlyZW1vdGUiLCJtdWx0aWJyb3dzZXIiLCJNdWx0aVJlbW90ZSIsImJyb3dzZXJOYW1lcyIsImtleXMiLCJQcm9taXNlIiwiYWxsIiwibWFwIiwiYnJvd3Nlck5hbWUiLCJhZGRJbnN0YW5jZSIsInNlc3Npb25QYXJhbXMiLCJzZXNzaW9uSWQiLCJpc1czQyIsImluc3RhbmNlcyIsImxvZ0xldmVsIiwiZHJpdmVyIiwiZ2V0UHJvdG90eXBlT2YiLCJiYXNlSW5zdGFuY2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOzs7O0FBRUE7Ozs7Ozs7QUFPTyxNQUFNQSxNQUFNLEdBQUcsZ0JBQWdCQyxNQUFNLEdBQUcsRUFBekIsRUFBNkJDLGNBQTdCLEVBQTZDO0FBQy9ELFFBQU1DLE1BQU0sR0FBRyw0QkFBZUMsd0JBQWYsRUFBOEJILE1BQTlCLENBQWY7O0FBQ0EsUUFBTUksUUFBUSxHQUFHLENBQUNDLE1BQUQsRUFBU0MsT0FBVCxLQUFxQjtBQUNsQyxRQUFJLE9BQU9MLGNBQVAsS0FB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RCxFQUFPQyxFQUFQLEVBQVdDLGVBQVgsS0FBK0I7QUFDckRDLElBQUFBLG9CQUFvQixDQUFDSCxJQUFELEVBQU8saUNBQW9CQyxFQUFwQixDQUFQLEVBQWdDQyxlQUFoQyxFQUFpRG5CLE1BQU0sQ0FBQ3dDLGNBQVAsQ0FBc0JmLFlBQVksQ0FBQ2dCLFlBQW5DLENBQWpELEVBQW1HaEIsWUFBWSxDQUFDWSxTQUFoSCxDQUFwQjtBQUNILEdBRkQ7O0FBSUEsU0FBT0UsTUFBUDtBQUNILENBOUNNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhdGggZnJvbSAncGF0aCdcbmltcG9ydCBXZWJEcml2ZXIgZnJvbSAnd2ViZHJpdmVyJ1xuaW1wb3J0IHsgdmFsaWRhdGVDb25maWcsIHdyYXBDb21tYW5kLCBydW5GbkluRmliZXJDb250ZXh0LCBkZXRlY3RCYWNrZW5kIH0gZnJvbSAnQHdkaW8vY29uZmlnJ1xuXG5pbXBvcnQgTXVsdGlSZW1vdGUgZnJvbSAnLi9tdWx0aXJlbW90ZSdcbmltcG9ydCB7IFdESU9fREVGQVVMVFMgfSBmcm9tICcuL2NvbnN0YW50cydcbmltcG9ydCB7IGdldFByb3RvdHlwZSB9IGZyb20gJy4vdXRpbHMnXG5cbi8qKlxuICogQSBtZXRob2QgdG8gY3JlYXRlIGEgbmV3IHNlc3Npb24gd2l0aCBXZWJkcml2ZXJJT1xuICpcbiAqIEBwYXJhbSAge09iamVjdH0gW3BhcmFtcz17fV0gICAgICAgT3B0aW9ucyB0byBjcmVhdGUgdGhlIHNlc3Npb24gd2l0aFxuICogQHBhcmFtICB7ZnVuY3Rpb259IHJlbW90ZU1vZGlmaWVyICBNb2RpZmllciBmdW5jdGlvbiB0byBjaGFuZ2UgdGhlIG1vbmFkIG9iamVjdFxuICogQHJldHVybiB7b2JqZWN0fSAgICAgICAgICAgICAgICAgICBicm93c2VyIG9iamVjdCB3aXRoIHNlc3Npb25JZFxuICovXG5leHBvcnQgY29uc3QgcmVtb3RlID0gYXN5bmMgZnVuY3Rpb24gKHBhcmFtcyA9IHt9LCByZW1vdGVNb2RpZmllcikge1xuICAgIGNvbnN0IGNvbmZpZyA9IHZhbGlkYXRlQ29uZmlnKFdESU9fREVGQVVMVFMsIHBhcmFtcylcbiAgICBjb25zdCBtb2RpZmllciA9IChjbGllbnQsIG9wdGlvbnMpID0+IHtcbiAgICAgICAgaWYgKHR5cGVvZiByZW1vdGVNb2RpZmllciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgY2xpZW50ID0gcmVtb3RlTW9kaWZpZXIoY2xpZW50LCBPYmplY3QuYXNzaWduKG9wdGlvbnMsIGNvbmZpZykpXG4gICAgICAgIH1cblxuICAgICAgICBPYmplY3QuYXNzaWduKG9wdGlvbnMsIGNvbmZpZylcbiAgICAgICAgcmV0dXJuIGNsaWVudFxuICAgIH1cblxuICAgIGlmIChwYXJhbXMudXNlciAmJiBwYXJhbXMua2V5KSB7XG4gICAgICAgIHBhcmFtcyA9IE9iamVjdC5hc3NpZ24oe30sIGRldGVjdEJhY2tlbmQocGFyYW1zKSwgcGFyYW1zKVxuICAgIH1cblxuICAgIGlmKHBhcmFtcy5vdXRwdXREaXIpe1xuICAgICAgICBwcm9jZXNzLmVudi5XRElPX0xPR19QQVRIID0gcGF0aC5qb2luKHBhcmFtcy5vdXRwdXREaXIsICd3ZGlvLmxvZycpXG4gICAgfVxuXG4gICAgY29uc3QgcHJvdG90eXBlID0gZ2V0UHJvdG90eXBlKCdicm93c2VyJylcbiAgICBjb25zdCBpbnN0YW5jZSA9IGF3YWl0IFdlYkRyaXZlci5uZXdTZXNzaW9uKHBhcmFtcywgbW9kaWZpZXIsIHByb3RvdHlwZSwgd3JhcENvbW1hbmQpXG5cbiAgICAvKipcbiAgICAgKiB3ZSBuZWVkIHRvIG92ZXJ3cml0ZSB0aGUgb3JpZ2luYWwgYWRkQ29tbWFuZCBhbmQgb3ZlcndyaXRlQ29tbWFuZFxuICAgICAqIGluIG9yZGVyIHRvIHdyYXAgdGhlIGZ1bmN0aW9uIHdpdGhpbiBGaWJlcnNcbiAgICAgKi9cbiAgICBjb25zdCBvcmlnQWRkQ29tbWFuZCA9IDo6aW5zdGFuY2UuYWRkQ29tbWFuZFxuICAgIGluc3RhbmNlLmFkZENvbW1hbmQgPSAobmFtZSwgZm4sIGF0dGFjaFRvRWxlbWVudCkgPT4gKFxuICAgICAgICBvcmlnQWRkQ29tbWFuZChuYW1lLCBydW5GbkluRmliZXJDb250ZXh0KGZuKSwgYXR0YWNoVG9FbGVtZW50KVxuICAgIClcblxuICAgIGNvbnN0IG9yaWdPdmVyd3JpdGVDb21tYW5kID0gOjppbnN0YW5jZS5vdmVyd3JpdGVDb21tYW5kXG4gICAgaW5zdGFuY2Uub3ZlcndyaXRlQ29tbWFuZCA9IChuYW1lLCBmbiwgYXR0YWNoVG9FbGVtZW50KSA9PiAoXG4gICAgICAgIG9yaWdPdmVyd3JpdGVDb21tYW5kKG5hbWUsIHJ1bkZuSW5GaWJlckNvbnRleHQoZm4pLCBhdHRhY2hUb0VsZW1lbnQpXG4gICAgKVxuXG4gICAgcmV0dXJuIGluc3RhbmNlXG59XG5cbmV4cG9ydCBjb25zdCBhdHRhY2ggPSBmdW5jdGlvbiAocGFyYW1zKSB7XG4gICAgY29uc3QgcHJvdG90eXBlID0gZ2V0UHJvdG90eXBlKCdicm93c2VyJylcbiAgICByZXR1cm4gV2ViRHJpdmVyLmF0dGFjaFRvU2Vzc2lvbihwYXJhbXMsIG51bGwsIHByb3RvdHlwZSwgd3JhcENvbW1hbmQpXG59XG5cbmV4cG9ydCBjb25zdCBtdWx0aXJlbW90ZSA9IGFzeW5jIGZ1bmN0aW9uIChwYXJhbXMgPSB7fSkge1xuICAgIGNvbnN0IG11bHRpYnJvd3NlciA9IG5ldyBNdWx0aVJlbW90ZSgpXG4gICAgY29uc3QgYnJvd3Nlck5hbWVzID0gT2JqZWN0LmtleXMocGFyYW1zKVxuXG4gICAgLyoqXG4gICAgICogY3JlYXRlIGFsbCBpbnN0YW5jZSBzZXNzaW9uc1xuICAgICAqL1xuICAgIGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgICBicm93c2VyTmFtZXMubWFwKChicm93c2VyTmFtZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY29uZmlnID0gdmFsaWRhdGVDb25maWcoV0RJT19ERUZBVUxUUywgcGFyYW1zW2Jyb3dzZXJOYW1lXSlcbiAgICAgICAgICAgIGNvbnN0IG1vZGlmaWVyID0gKGNsaWVudCwgb3B0aW9ucykgPT4ge1xuICAgICAgICAgICAgICAgIE9iamVjdC5hc3NpZ24ob3B0aW9ucywgY29uZmlnKVxuICAgICAgICAgICAgICAgIHJldHVybiBjbGllbnRcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IHByb3RvdHlwZSA9IGdldFByb3RvdHlwZSgnYnJvd3NlcicpXG4gICAgICAgICAgICBjb25zdCBpbnN0YW5jZSA9IFdlYkRyaXZlci5uZXdTZXNzaW9uKHBhcmFtc1ticm93c2VyTmFtZV0sIG1vZGlmaWVyLCBwcm90b3R5cGUsIHdyYXBDb21tYW5kKVxuICAgICAgICAgICAgcmV0dXJuIG11bHRpYnJvd3Nlci5hZGRJbnN0YW5jZShicm93c2VyTmFtZSwgaW5zdGFuY2UpXG4gICAgICAgIH0pXG4gICAgKVxuXG4gICAgLyoqXG4gICAgICogdXNlIGF0dGFjaFRvU2Vzc2lvbiBjYXBhYmlsaXR5IHRvIHdyYXAgaW5zdGFuY2VzIGFyb3VuZCBibGFuayBwb2RcbiAgICAgKi9cbiAgICBjb25zdCBwcm90b3R5cGUgPSBnZXRQcm90b3R5cGUoJ2Jyb3dzZXInKVxuICAgIGNvbnN0IHNlc3Npb25QYXJhbXMgPSB7XG4gICAgICAgIHNlc3Npb25JZDogJycsXG4gICAgICAgIGlzVzNDOiBtdWx0aWJyb3dzZXIuaW5zdGFuY2VzW2Jyb3dzZXJOYW1lc1swXV0uaXNXM0MsXG4gICAgICAgIGxvZ0xldmVsOiBtdWx0aWJyb3dzZXIuaW5zdGFuY2VzW2Jyb3dzZXJOYW1lc1swXV0ub3B0aW9ucy5sb2dMZXZlbFxuICAgIH1cbiAgICBjb25zdCBkcml2ZXIgPSBXZWJEcml2ZXIuYXR0YWNoVG9TZXNzaW9uKHNlc3Npb25QYXJhbXMsIDo6bXVsdGlicm93c2VyLm1vZGlmaWVyLCBwcm90b3R5cGUsIHdyYXBDb21tYW5kKVxuXG4gICAgLyoqXG4gICAgICogaW4gb3JkZXIgdG8gZ2V0IGN1c3RvbSBjb21tYW5kIG92ZXJ3cml0dGVuIG9yIGFkZGVkIHRvIG11bHRpcmVtb3RlIGluc3RhbmNlXG4gICAgICogd2UgbmVlZCB0byBwYXNzIGluIHRoZSBwcm90b3R5cGUgb2YgdGhlIG11bHRpYnJvd3NlclxuICAgICAqL1xuICAgIGNvbnN0IG9yaWdBZGRDb21tYW5kID0gOjpkcml2ZXIuYWRkQ29tbWFuZFxuICAgIGRyaXZlci5hZGRDb21tYW5kID0gKG5hbWUsIGZuLCBhdHRhY2hUb0VsZW1lbnQpID0+IHtcbiAgICAgICAgb3JpZ0FkZENvbW1hbmQobmFtZSwgcnVuRm5JbkZpYmVyQ29udGV4dChmbiksIGF0dGFjaFRvRWxlbWVudCwgT2JqZWN0LmdldFByb3RvdHlwZU9mKG11bHRpYnJvd3Nlci5iYXNlSW5zdGFuY2UpLCBtdWx0aWJyb3dzZXIuaW5zdGFuY2VzKVxuICAgIH1cblxuICAgIGNvbnN0IG9yaWdPdmVyd3JpdGVDb21tYW5kID0gOjpkcml2ZXIub3ZlcndyaXRlQ29tbWFuZFxuICAgIGRyaXZlci5vdmVyd3JpdGVDb21tYW5kID0gKG5hbWUsIGZuLCBhdHRhY2hUb0VsZW1lbnQpID0+IHtcbiAgICAgICAgb3JpZ092ZXJ3cml0ZUNvbW1hbmQobmFtZSwgcnVuRm5JbkZpYmVyQ29udGV4dChmbiksIGF0dGFjaFRvRWxlbWVudCwgT2JqZWN0LmdldFByb3RvdHlwZU9mKG11bHRpYnJvd3Nlci5iYXNlSW5zdGFuY2UpLCBtdWx0aWJyb3dzZXIuaW5zdGFuY2VzKVxuICAgIH1cblxuICAgIHJldHVybiBkcml2ZXJcbn1cbiJdfQ==